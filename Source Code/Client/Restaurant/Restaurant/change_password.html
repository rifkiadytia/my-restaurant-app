<!DOCTYPE html> 
<html>
<head>
<meta charset="utf-8">
<title>jQuery Mobile Web App</title>
<link href="../jquery-mobile/jquery.mobile.theme-1.0.min.css" rel="stylesheet" type="text/css"/>
<link href="../jquery-mobile/jquery.mobile.structure-1.0.min.css" rel="stylesheet" type="text/css"/>
<script src="../jquery-mobile/jquery-1.6.4.min.js" type="text/javascript"></script>
<script src="../jquery-mobile/jquery.mobile-1.0.min.js" type="text/javascript"></script>
</head> 
<body>
<div data-role="page" id="changePassword">

<script>
	
	$(document).ready(function(e) {
		$("#changePasswordForm").submit(function(){
			var userNameChange= $('#usernameChange').val();
			var passwordChange =$('#passwordChange').val();
			var confirmPasswordChange =$('#confirmpasswordChange').val();
			if(userNameChange==""||passwordChange==""||confirmPasswordChange==""){
				return;
			}
			if(passwordChange!=confirmPasswordChange){
				return;
			}
			$.ajax({
                    type: "POST",
                    url: "http://localhost:43415/Account/ClientChangePassword",
                    cache: false,
                    data: {userNameChange:userNameChange,passwordChange:passwordChange,currentDateChange:Math.random()},
                    success: function (data){
						var hasAdminRole =$('#hiddenHasAdmin').val();
						if(data.dateCode=="1"){
							if(hasAdminRole=='true'){
									$.mobile.changePage( "index.html", { transition: "slideup", changeHash: false });
							}
							else{
								$.mobile.changePage( "waiter.html", { transition: "slideup", changeHash: false });
							}
						}
						
					},
                    error: function(e){
						alert('Error occur');
					}
            });
            return false;
			
		});
		
    });
	$('#changePassword').bind('pageshow', function(event, ui) {
		var url = $("#changePassword" ).attr("data-url");	
        var userName = getPamarByName(url,'userName');
		var hasAdminRole = getPamarByName(url,'hasAdminRole'); 
		$('#usernameChange').val(userName);
		$('#hiddenHasAdmin').val(hasAdminRole);
	});
	/*
	function getParameterByName(name) {
		var match = RegExp('[?&]' + name + '=([^&]*)').exec(window.location.search);
		return match && decodeURIComponent(match[1].replace(/\+/g, ' '));
	}
	*/
	function getPamarByName(url, paramName){ 
		var strGET = url.substr(url.indexOf('?')+1,url.length - url.indexOf('?')); 
		var arrGET = strGET.split("&"); 
		var paramValue = '';
		for(i=0;i<arrGET.length;i++){ 
			  var aux = arrGET[i].split("="); 
			  if (aux[0] == paramName){
					paramValue = aux[1];
			  }
		} 
		return paramValue;
	}
</script>
        <div data-theme="a" data-role="header">
            <h4>Change password</h4>
        </div>

        <div data-role="content">
			<form id="changePasswordForm">
        <div data-role="fieldcontain" class="ui-hide-label">
            <span id="lblErr" style="color:#F00; display:none"></span>            <label for="usernameChange">Username:</label>
            <input type="text" name="usernameChange" id="usernameChange" value="" placeholder="Username" />
        </div>

        <div data-role="fieldcontain" class="ui-hide-label">
            <label for="passwordChange">Password:</label>
            <input type="password" name="passwordChange" id="passwordChange" value="" placeholder="Password" />
        </div>
		<div data-role="fieldcontain" class="ui-hide-label">
            <label for="confirmpasswordChange">Confirm password:</label>
            <input type="password" name="confirmpasswordChange" id="confirmpasswordChange" value="" placeholder="Confirm password" />
        </div>
        <input type="hidden" value="" id="hiddenHasAdmin">
    	<input type="submit" value="Ok" id="btnOk">
    </form>	
        </div>

        <div data-theme="a" data-role="footer" data-position="fixed">

        </div>
</div> 
</body>
</html>